name: CI

# Callers must grant these permissions for preview comment posting:
#   permissions:
#     contents: read
#     issues: write
#     pull-requests: write

on:
  workflow_call:
    inputs:
      app_name:
        description: 'App name (used for Fly app naming)'
        required: true
        type: string
      fly_org:
        description: 'Fly.io organization'
        required: false
        type: string
        default: 'personal'
      fly_region:
        description: 'Fly.io region'
        required: false
        type: string
        default: 'iad'
      doppler_project:
        description: 'Doppler project name (defaults to app_name)'
        required: false
        type: string
        default: ''
      node_version:
        description: 'Node.js version'
        required: false
        type: string
        default: '20'
      skip_e2e:
        description: 'Skip E2E tests'
        required: false
        type: boolean
        default: false
      runner:
        description: 'Blacksmith runner to use'
        required: false
        type: string
        default: 'blacksmith'
      custom_domain:
        description: 'Custom domain (e.g., app.example.com) - uses flyctl health checks instead of curl'
        required: false
        type: string
        default: ''
      preview_label:
        description: 'PR label required to trigger preview deploy (empty = auto-deploy)'
        required: false
        type: string
        default: ''
      frontend_directory:
        description: 'Frontend subdirectory (e.g., frontend/) - runs Node.js CI separately for monorepos'
        required: false
        type: string
        default: ''
      staging_app_name:
        description: 'Override Fly app name for staging (defaults to {app_name}-staging)'
        required: false
        type: string
        default: ''

jobs:
  # ============================================
  # Graphite CI Optimizer
  # Determines if this PR should run full CI
  # ============================================
  graphite_ci:
    runs-on: ${{ inputs.runner }}
    outputs:
      skip: ${{ steps.comment_skip.outputs.skip || steps.check.outputs.skip || 'false' }}
    steps:
      - name: Skip CI for issue_comment events
        if: github.event_name == 'issue_comment'
        id: comment_skip
        run: echo "skip=true" >> $GITHUB_OUTPUT

      - name: Graphite CI Optimizer
        if: github.event_name == 'pull_request'
        id: check
        uses: withgraphite/graphite-ci-action@main
        with:
          graphite_token: ${{ secrets.GRAPHITE_CI_OPTIMIZER_TOKEN }}

  # ============================================
  # Lint Backend - Skipped on mid-stack PRs
  # ============================================
  lint_backend:
    needs: [graphite_ci]
    if: needs.graphite_ci.outputs.skip == 'false'
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/lint@main
        with:
          node_version: ${{ inputs.node_version }}

  # ============================================
  # Lint Frontend - Runs when frontend_directory is set
  # ============================================
  lint_frontend:
    needs: [graphite_ci]
    if: |
      needs.graphite_ci.outputs.skip == 'false' &&
      inputs.frontend_directory != ''
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/lint@main
        with:
          node_version: ${{ inputs.node_version }}
          working_directory: ${{ inputs.frontend_directory }}

  # ============================================
  # Build Backend - Skipped on mid-stack PRs
  # ============================================
  build_backend:
    needs: [graphite_ci, lint_backend]
    if: needs.graphite_ci.outputs.skip == 'false'
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/build@main
        with:
          node_version: ${{ inputs.node_version }}

  # ============================================
  # Build Frontend - Runs when frontend_directory is set
  # ============================================
  build_frontend:
    needs: [graphite_ci, lint_frontend]
    if: |
      needs.graphite_ci.outputs.skip == 'false' &&
      inputs.frontend_directory != ''
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/build@main
        with:
          node_version: ${{ inputs.node_version }}
          working_directory: ${{ inputs.frontend_directory }}

  # ============================================
  # Scan Backend - Skipped on mid-stack PRs
  # ============================================
  scan_backend:
    needs: [graphite_ci, build_backend]
    if: needs.graphite_ci.outputs.skip == 'false'
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/scan@main

  # ============================================
  # Scan Frontend - Runs when frontend_directory is set
  # ============================================
  scan_frontend:
    needs: [graphite_ci, build_frontend]
    if: |
      needs.graphite_ci.outputs.skip == 'false' &&
      inputs.frontend_directory != ''
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/scan@main
        with:
          working_directory: ${{ inputs.frontend_directory }}

  # ============================================
  # Test Backend - Skipped on mid-stack PRs
  # ============================================
  test_backend:
    needs: [graphite_ci, build_backend]
    if: needs.graphite_ci.outputs.skip == 'false'
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/test@main
        with:
          node_version: ${{ inputs.node_version }}

  # ============================================
  # Test Frontend - Runs when frontend_directory is set
  # ============================================
  test_frontend:
    needs: [graphite_ci, build_frontend]
    if: |
      needs.graphite_ci.outputs.skip == 'false' &&
      inputs.frontend_directory != ''
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/test@main
        with:
          node_version: ${{ inputs.node_version }}
          working_directory: ${{ inputs.frontend_directory }}

  # ============================================
  # Deploy Preview - Gated by preview_label when set
  # Auto-deploys when preview_label is empty (default)
  # ============================================
  deploy_preview:
    needs: [graphite_ci, test_backend, scan_backend, test_frontend, scan_frontend]
    if: |
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      needs.graphite_ci.outputs.skip == 'false' &&
      (inputs.preview_label == '' || contains(github.event.pull_request.labels.*.name, inputs.preview_label))
    runs-on: ${{ inputs.runner }}
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.url }}
    concurrency:
      group: preview-pr-${{ github.event.number }}
      cancel-in-progress: true
    outputs:
      app_name: ${{ steps.app.outputs.name }}
    steps:
      - uses: actions/checkout@v4

      - name: Set app name
        id: app
        run: echo "name=${{ inputs.app_name }}-pr-${{ github.event.number }}" >> $GITHUB_OUTPUT

      - name: Install Doppler CLI
        run: curl -Ls https://cli.doppler.com/install.sh | sudo sh

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Get Fly API Token
        id: fly_token
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN_DEV }}
        run: |
          echo "token=$(doppler secrets get FLY_API_TOKEN --plain --project ${{ inputs.doppler_project || inputs.app_name }} --config dev)" >> $GITHUB_OUTPUT

      - name: Sync Doppler secrets to preview app
        id: sync_secrets
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN_DEV }}
        run: |
          SECRETS=$(doppler secrets download \
            --project "${{ inputs.doppler_project || inputs.app_name }}" \
            --config dev \
            --no-file \
            --format env \
            | grep -v "^FLY_API_TOKEN=" \
            | tr '\n' ' ')
          echo "secrets<<EOF" >> $GITHUB_OUTPUT
          echo "$SECRETS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Deploy Preview
        id: deploy
        uses: superfly/fly-pr-review-apps@main
        env:
          FLY_API_TOKEN: ${{ steps.fly_token.outputs.token }}
        with:
          name: ${{ steps.app.outputs.name }}
          region: ${{ inputs.fly_region }}
          org: ${{ inputs.fly_org }}
          config: fly.preview.toml
          secrets: ${{ steps.sync_secrets.outputs.secrets }}

  # ============================================
  # E2E Tests - Against preview deployment
  # ============================================
  e2e:
    needs: [deploy_preview]
    if: |
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      inputs.skip_e2e == false
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/test@main
        with:
          node_version: ${{ inputs.node_version }}
          test_type: e2e
          base_url: https://${{ inputs.app_name }}-pr-${{ github.event.number }}.fly.dev

  # ============================================
  # Cleanup Preview - On PR close
  # Preview machines auto-suspend when idle (auto_stop_machines=suspend)
  # ============================================
  cleanup_preview:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Install Doppler CLI
        run: curl -Ls https://cli.doppler.com/install.sh | sudo sh

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Get Fly API Token
        id: fly_token
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN_DEV }}
        run: |
          echo "token=$(doppler secrets get FLY_API_TOKEN --plain --project ${{ inputs.doppler_project || inputs.app_name }} --config dev)" >> $GITHUB_OUTPUT

      - name: Cleanup Preview
        env:
          FLY_API_TOKEN: ${{ steps.fly_token.outputs.token }}
        run: |
          flyctl apps destroy ${{ inputs.app_name }}-pr-${{ github.event.number }} --yes || true

  # ============================================
  # Preview via /preview comment
  # Triggered when consuming repo includes issue_comment in its on: triggers
  # ============================================
  preview_comment:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/preview')
    runs-on: ${{ inputs.runner }}
    environment:
      name: preview
      url: https://${{ inputs.app_name }}-pr-${{ github.event.issue.number }}.fly.dev
    concurrency:
      group: preview-pr-${{ github.event.issue.number }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head

      - name: Set app name
        id: app
        run: echo "name=${{ inputs.app_name }}-pr-${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

      - name: Install Doppler CLI
        run: curl -Ls https://cli.doppler.com/install.sh | sudo sh

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Get Fly API Token
        id: fly_token
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN_DEV }}
        run: |
          echo "token=$(doppler secrets get FLY_API_TOKEN --plain --project ${{ inputs.doppler_project || inputs.app_name }} --config dev)" >> $GITHUB_OUTPUT

      - name: Sync Doppler secrets to preview app
        id: sync_secrets
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN_DEV }}
        run: |
          SECRETS=$(doppler secrets download \
            --project "${{ inputs.doppler_project || inputs.app_name }}" \
            --config dev \
            --no-file \
            --format env \
            | grep -v "^FLY_API_TOKEN=" \
            | tr '\n' ' ')
          echo "secrets<<EOF" >> $GITHUB_OUTPUT
          echo "$SECRETS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Deploy Preview
        id: deploy
        uses: BristolAI-com/fly-pr-review-apps@main
        env:
          FLY_API_TOKEN: ${{ steps.fly_token.outputs.token }}
        with:
          name: ${{ steps.app.outputs.name }}
          region: ${{ inputs.fly_region }}
          org: ${{ inputs.fly_org }}
          config: fly.preview.toml
          secrets: ${{ steps.sync_secrets.outputs.secrets }}

      - name: Comment preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: `Preview deployed: https://${{ inputs.app_name }}-pr-${{ github.event.issue.number }}.fly.dev`
            })

  # ============================================
  # Deploy Dev - On push to develop
  # ============================================
  deploy_dev:
    needs: [test_backend, scan_backend, test_frontend, scan_frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    runs-on: ${{ inputs.runner }}
    environment:
      name: dev
      url: ${{ inputs.custom_domain && format('https://{0}-dev.{1}', inputs.app_name, inputs.custom_domain) || format('https://{0}-dev.fly.dev', inputs.app_name) }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/deploy@main
        with:
          environment: dev
          app_name: ${{ inputs.app_name }}-dev
          config_file: fly.dev.toml
          doppler_token: ${{ secrets.DOPPLER_TOKEN_DEV }}
          doppler_project: ${{ inputs.doppler_project || inputs.app_name }}

  # ============================================
  # Deploy Staging - On push to main
  # ============================================
  deploy_staging:
    needs: [test_backend, scan_backend, test_frontend, scan_frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ${{ inputs.runner }}
    environment:
      name: staging
      url: ${{ inputs.custom_domain && format('https://{0}-staging.{1}', inputs.app_name, inputs.custom_domain) || format('https://{0}-staging.fly.dev', inputs.app_name) }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/deploy@main
        with:
          environment: stg
          app_name: ${{ inputs.staging_app_name || format('{0}-staging', inputs.app_name) }}
          config_file: fly.staging.toml
          doppler_token: ${{ secrets.DOPPLER_TOKEN_STG }}
          doppler_project: ${{ inputs.doppler_project || inputs.app_name }}

      - name: Smoke Test Staging
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN_STG }}
        run: |
          STAGING_APP="${{ inputs.staging_app_name || format('{0}-staging', inputs.app_name) }}"
          export FLY_API_TOKEN=$(doppler secrets get FLY_API_TOKEN --plain \
            --project "${{ inputs.doppler_project || inputs.app_name }}" --config stg)
          echo "Verifying health checks for $STAGING_APP..."
          sleep 5
          CHECKS=$(flyctl checks list --app "$STAGING_APP" --json)
          echo "$CHECKS" | jq .
          FAILING=$(echo "$CHECKS" | jq '[.[][] | select(.status != "passing")] | length')
          if [ "$FAILING" -gt 0 ]; then
            echo "ERROR: $FAILING health check(s) not passing"
            exit 1
          fi
          echo "All health checks passing"

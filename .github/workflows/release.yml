name: Release

on:
  workflow_call:
    inputs:
      app_name:
        description: 'App name'
        required: true
        type: string
      fly_org:
        description: 'Fly.io organization'
        required: false
        type: string
        default: 'personal'
      fly_region:
        description: 'Fly.io region'
        required: false
        type: string
        default: 'iad'
      doppler_project:
        description: 'Doppler project name (defaults to app_name)'
        required: false
        type: string
        default: ''
      runner:
        description: 'Blacksmith runner to use'
        required: false
        type: string
        default: 'blacksmith'
      custom_domain:
        description: 'Custom domain (e.g., app.example.com) - uses flyctl health checks instead of curl'
        required: false
        type: string
        default: ''
      release_type:
        description: 'Release-please release type (node, python, simple, etc.)'
        required: false
        type: string
        default: 'node'

jobs:
  # ============================================
  # Release - Create changelog and GitHub release
  # ============================================
  release:
    runs-on: ${{ inputs.runner }}
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          release-type: ${{ inputs.release_type }}

  # ============================================
  # Deploy Production - On release created
  # ============================================
  deploy_production:
    needs: [release]
    if: needs.release.outputs.release_created == 'true'
    runs-on: ${{ inputs.runner }}
    environment:
      name: production
      url: ${{ inputs.custom_domain && format('https://{0}.{1}', inputs.app_name, inputs.custom_domain) || format('https://{0}.fly.dev', inputs.app_name) }}
    steps:
      - uses: actions/checkout@v4

      - uses: BristolAI-com/CI-Components/.github/actions/deploy@main
        with:
          environment: prd
          app_name: ${{ inputs.app_name }}
          config_file: fly.toml
          doppler_token: ${{ secrets.DOPPLER_TOKEN_PRD }}
          doppler_project: ${{ inputs.doppler_project || inputs.app_name }}

      - name: Smoke Test Production
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN_PRD }}
        run: |
          export FLY_API_TOKEN=$(doppler secrets get FLY_API_TOKEN --plain \
            --project "${{ inputs.doppler_project || inputs.app_name }}" --config prd)
          echo "Verifying health checks for ${{ inputs.app_name }}..."
          sleep 5
          CHECKS=$(flyctl checks list --app ${{ inputs.app_name }} --json)
          echo "$CHECKS" | jq .
          FAILING=$(echo "$CHECKS" | jq '[.[][] | select(.status != "passing")] | length')
          if [ "$FAILING" -gt 0 ]; then
            echo "ERROR: $FAILING health check(s) not passing"
            exit 1
          fi
          echo "All health checks passing"

      - name: Notify Release
        if: success()
        run: |
          echo "ðŸš€ Released ${{ needs.release.outputs.tag_name }} to production"
          # Add Slack/Teams webhook notification here if desired

name: 'Deploy'
description: 'Deploy to Fly.io (secrets synced via Doppler integration)'

inputs:
  environment:
    description: 'Environment: dev, stg, or prd'
    required: true
  app_name:
    description: 'Fly.io app name'
    required: true
  config_file:
    description: 'Fly.io config file (fly.toml)'
    required: false
    default: 'fly.toml'
  doppler_token:
    description: 'Doppler service token'
    required: true
  doppler_project:
    description: 'Doppler project name'
    required: true
  working_directory:
    description: 'Working directory'
    required: false
    default: '.'

outputs:
  url:
    description: 'Deployed app URL'
    value: ${{ steps.deploy.outputs.url }}

runs:
  using: 'composite'
  steps:
    - name: Setup Fly CLI
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: Install Doppler CLI
      shell: bash
      run: |
        curl -Ls https://cli.doppler.com/install.sh | sudo sh

    - name: Deploy to Fly.io
      id: deploy
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      env:
        DOPPLER_TOKEN: ${{ inputs.doppler_token }}
      run: |
        # Get FLY_API_TOKEN from Doppler
        export FLY_API_TOKEN=$(doppler secrets get FLY_API_TOKEN --plain \
          --project "${{ inputs.doppler_project }}" \
          --config "${{ inputs.environment }}")

        # Secrets are synced via the Doppler-Fly.io integration
        # Deploy the app
        echo "Deploying to Fly.io..."
        flyctl deploy \
          --app "${{ inputs.app_name }}" \
          --config "${{ inputs.config_file }}" \
          --remote-only \
          --wait-timeout 300

        # Output the URL
        echo "url=https://${{ inputs.app_name }}.fly.dev" >> $GITHUB_OUTPUT

    - name: Verify deployment
      shell: bash
      env:
        DOPPLER_TOKEN: ${{ inputs.doppler_token }}
      run: |
        export FLY_API_TOKEN=$(doppler secrets get FLY_API_TOKEN --plain \
          --project "${{ inputs.doppler_project }}" \
          --config "${{ inputs.environment }}")
        echo "Checking deployment status..."
        flyctl status --app "${{ inputs.app_name }}"
